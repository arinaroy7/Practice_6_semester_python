# Функциональные возможности 
# сервиса СОПД по архитектуре

## 1. Работа администратора с шаблоном СОПД

1. Администратор авторизуется во фронте (`App → Auth`: проверка логина/пароля, JWT).  
2. Открывает раздел «Шаблон СОПД».  
3. Загружает текущий действующий шаблон из сервиса (`App → Template`).  
4. Вносит изменения в текст письма или СОПД.  
5. Сохраняет обновлённый шаблон в БД с перезаписью предыдущей версии (`Template → DB`).  
6. Выполняет предпросмотр письма для проверки результата.  

**Функции Template**:
- Хранение единственного актуального шаблона.  
- Редактирование шаблона с перезаписью данных.  
- Предпросмотр с подстановкой тестовых данных.  
- Аудит изменений (кто и когда редактировал).  

## 2. Отправка СОПД менеджером

1. Менеджер авторизуется (`App → Auth`).  
2. Создаёт запрос на согласие, вводя данные кандидата (ФИО, email, вакансия, срок действия ссылки).  
3. Запрашивает у сервиса действующий шаблон для отправки (`App → Template`).  
4. Отправляет команду «Создать запрос» в Template.  
5. Template регистрирует кандидата в БД, генерирует уникальную ссылку.  
6. Template передаёт письмо с подставленными данными в Email-сервис (`Template → Email`).  
7. Email-сервис отправляет письмо через SMTP (`Email → Mail`).  
8. Email-сервис сохраняет лог отправки (`Email → DB`).  
9. Фронтенд отображает менеджеру результат отправки.  

**Функции Email**:
- Отправка писем через SMTP.  
- Логирование факта отправки и статусов.  
- Подстановка переменных в шаблон (если требуется).  

## 3. Получение письма и заполнение формы кандидатом

1. Кандидат получает письмо (`Mail → Кандидат`).  
2. Переходит по уникальной ссылке (`Кандидат → App`).  
3. Фронтенд проверяет ссылку через Template (`App → Template`) или Auth (`App → Auth`).  
4. Загружает текст СОПД для отображения.  
5. Кандидат заполняет форму согласия или отказа.  
6. Данные формы отправляются в Template.  
7. Template фиксирует результат в БД (согласие/отказ, дата, IP).  
8. (При необходимости) Template уведомляет менеджера об ответе.  


## 4. Мониторинг и управление отправками

1. Менеджер открывает список «Мои отправки».  
2. Фронтенд запрашивает у Template список согласий и статусов.  
3. Отображается история отправок с деталями.  
4. Возможность повторной отправки письма или отзыва ссылки.  

## 5. Администрирование пользователей и ролей

- Роли: **Администратор** (редактирует шаблон) и **Менеджер** (отправляет СОПД и отслеживает ответы).  
- Авторизация через Auth по JWT (`Auth → DB`).  
- Проверка прав доступа на уровне сервисов.  

## 6. Валидации и правила

- Срок действия уникальной ссылки (TTL).  
- Проверка формата email.  
- Использование только действующего шаблона.  
- Анти-replay защита для ссылок.  


## 7. Модели данных

- **User** — пользователь (администратор или менеджер).  
- **Template** — действующий шаблон письма и текста СОПД.  
- **Consent** — запрос на согласие.  
- **ConsentEvent** — события по согласию (отправка, открытие, ответ).  
- **LinkToken** — уникальная ссылка для кандидата.  
- **EmailLog** — информация об отправке письма.  